---
title: "Figures and Statistical Tests"
date: "2024-01-15"
---
Load libraries
```{r}
library(gridExtra)
library(grid)
library(ggplot2)
library(RColorBrewer)
library(dplyr)
library(readr)
library(emmeans)
library(tidyr)
library(ggpubr)

```

Load Color Palettes:
```{r}
AllColorOptions = c("#AA4499","#332288", "#0077BB", "#33BBEE", "#009988","#117733", "#EE7733", "#CC3311","#882255",  "#EE3377")
tol_palette9 <- c("#AA4499","#332288", "#0077BB", "#33BBEE", "#009988", "#117733", "#EE7733", "#CC3311","#882255",  "#EE3377","#AA3413","#EE5000","#EE1000") 
tol_palette2 <- c("#EE7733","#882255")
```

Load data:
```{r}
#truncated.weibull = read_csv("outputs/weibull.cut.hooks.csv")
#truncated.schoolfield = read_csv("outputs/schoolfield.cut.hooks.csv")
discard.weibull = read_csv("outputs/discard.weibull.SANW.csv")
discard.schoolfield = read_csv("outputs/discard.schoolfield.SANW.csv")
species.key = read.csv("data/Faster_Key.csv")
species.key.n=read_csv("data/Norway.Key.csv")
```

Join data with plot key info and get rid of extraneous columns
```{r}
discard.weibull$curveID = as.numeric(discard.weibull$curveID)
species.key<-species.key %>%
  rename(curveID = Obs)
discard.weibull <- left_join(discard.weibull,species.key, by="curveID")
discard.weibull <- left_join(discard.weibull,species.key.n, by="curveID")
discard.weibull<- discard.weibull%>%
  mutate(Species = ifelse(is.na(Species.y), taxon, Species.y)) %>%
  mutate(BarcodeLeaf = ifelse(is.na(BarcodeLeaf.x), ID, BarcodeLeaf.x)) %>%
  mutate(Date = ifelse(is.na(Date), Date.measured, Date)) %>%
  mutate(Elevation = ifelse(is.na(Elevation), Elevation.masl, Elevation)) %>%
  mutate(site = ifelse(is.na(SiteID), site, SiteID)) %>%
  mutate(site = ifelse(!is.na(siteID), site + 5, site))%>%
  mutate(country = ifelse(!is.na(siteID), "SA", "NW"))%>%
  select(-taxon, -ID, -X, -Date.collected,-Date.measured,-Elevation.masl,-SiteID,-species,-Species.x,-Species.y,-Note_1,-notes,-day,-remarks_2,-remark_dry_weighing,-remark_dry_weighing_rest,-notes_rest_1,-notes_rest_2,remarks_2_rest,-wet_mass_total_g,-dry_mass_total_g,-area_cutout_cm2,-area_total_cm2,-LMA_g_m2,-LDMC_mg_g,-leaf_thickness_avg_mm,-remarks_2_rest,-Notes,-NoRamp,-Bad,-BarcodeLeaf.y,-BarcodeLeaf.x,-BarcodeCutout)
  
discard.schoolfield$curveID = as.numeric(discard.schoolfield$curveID)
discard.schoolfield <- left_join(discard.schoolfield,species.key, by="curveID")
discard.schoolfield <- left_join(discard.schoolfield,species.key.n, by="curveID")
discard.schoolfield<- discard.schoolfield%>%
  mutate(Species = ifelse(is.na(Species.y), taxon, Species.y)) %>%
  mutate(BarcodeLeaf = ifelse(is.na(BarcodeLeaf.x), ID, BarcodeLeaf.x)) %>%
  mutate(Date = ifelse(is.na(Date), Date.measured, Date)) %>%
  mutate(Elevation = ifelse(is.na(Elevation), Elevation.masl, Elevation)) %>%
  mutate(site = ifelse(is.na(SiteID), site, SiteID)) %>%
  mutate(site = ifelse(!is.na(siteID), site + 5, site))%>%
  select(-taxon, -ID, -X, -Date.collected,-Date.measured,-Elevation.masl,-SiteID,-species,-Species.x,-Species.y,-Note_1,-notes,-day,-remarks_2,-remark_dry_weighing,-remark_dry_weighing_rest,-notes_rest_1,-notes_rest_2,remarks_2_rest,-wet_mass_total_g,-dry_mass_total_g,-area_cutout_cm2,-area_total_cm2,-LMA_g_m2,-LDMC_mg_g,-leaf_thickness_avg_mm,-remarks_2_rest,-Notes,-NoRamp,-Bad,-BarcodeLeaf.y,-BarcodeLeaf.x,-BarcodeCutout)
```

Join with flir averages:
```{r}
flir.avs = FLIRtomst%>%
  group_by(site, Aspect)%>%
  summarise(
    ave.air= mean(flir.Tair),
    ave.leaf= mean(flir.Tleaf),
    range.air = max(flir.Tair) - min(flir.Tair),
    range.leaf = max(flir.Tleaf) - min(flir.Tleaf))
discard.weibull$site <- as.numeric(discard.weibull$site)
flir.avs$site <- as.numeric(flir.avs$site)
discard.weibull = left_join(discard.weibull, flir.avs, by = c('site', 'Aspect'))
#truncated.weibull = left_join(truncated.weibull, flir.avs, by = c('site', 'Aspect'))
discard.schoolfield = left_join(discard.schoolfield, flir.avs, by = c('site', 'Aspect'))
#truncated.schoolfield = left_join(truncated.schoolfield, flir.avs, by = c('site', 'Aspect'))
```

Join data with tomst summary stats
```{r}
tomst = read_csv("data/PFTC7_Tomst_Data.csv")
date_conditions <- list(
  list(date = "2023-12-07", site = 1, aspect = "W"),
  list(date = "2023-12-07", site = 1, aspect = "E"),
  list(date = "2023-12-15", site = 2, aspect = "W"),
  list(date = "2023-12-08", site = 2, aspect = "E"),
  list(date = "2023-12-14", site = 2, aspect = "E"),
  list(date = "2023-12-11", site = 3, aspect = "W"),
  list(date = "2023-12-13", site = 3, aspect = "W"),
  list(date = "2023-12-14", site = 3, aspect = "E"),
  list(date = "2023-12-14", site = 4, aspect = "W"),
  list(date = "2023-12-13", site = 4, aspect = "E"),
  list(date = "2023-12-08", site = 5, aspect = "W"),
  list(date = "2023-12-10", site = 5, aspect = "E")
)

# Convert tomst data into the desired format
tomst.dayofcurve <- tomst %>%
  mutate(Elevation = case_when(
    site == 1 ~ 2000,
    site == 2 ~ 2200,
    site == 3 ~ 2400,
    site == 4 ~ 2600,
    site == 5 ~ 2800
  )) %>%
  mutate(Aspect = case_when(
    aspect == "east" ~ "E",
    aspect == "west" ~ "W"
  )) %>%
  mutate(datetime = as.POSIXct(datetime, tz = "Europe/London")) %>%
  filter(!rowSums(is.na(.)))

# Function to create a filter condition based on the date_conditions list
create_filter_condition <- function(df, date_conditions) {
  condition <- purrr::map_lgl(seq_len(nrow(df)), function(i) {
    any(purrr::map_lgl(date_conditions, function(cond) {
      as.Date(df$datetime[i]) == as.Date(cond$date) & 
        df$site[i] == cond$site & 
        df$Aspect[i] == cond$aspect
    }))
  })
  return(condition)
}

# Apply the filter conditions
tomst.dayofcurve <- tomst.dayofcurve %>%
  filter(create_filter_condition(tomst.dayofcurve, date_conditions)) %>%
  filter(format(datetime, "%H:%M:%S") >= "08:00:00" &
           format(datetime, "%H:%M:%S") <= "19:00:00") %>%
  rename(tomst.Tair = T3) %>%
  mutate(site = as.character(site)) %>%
  mutate(hourmin_str = format(datetime, "%Y-%m-%d %H:%M:%S"))

tomst.avs = tomst.dayofcurve%>%
  group_by(site, Aspect)%>%
  summarise(
    tom.ave.air= mean(tomst.Tair),
    tom.range.air = max(tomst.Tair) - min(tomst.Tair))
tomst.avs$site <- as.numeric(tomst.avs$site)
discard.weibull = left_join(discard.weibull, tomst.avs, by = c('site', 'Aspect'))
#truncated.weibull = left_join(truncated.weibull, tomst.avs, by = c('site', 'Aspect'))
discard.schoolfield = left_join(discard.schoolfield, tomst.avs, by = c('site', 'Aspect'))
#truncated.schoolfield = left_join(truncated.schoolfield, tomst.avs, by = c('site', 'Aspect'))
```

Make the final dataset into a csv:
```{r}
write.csv(discard.weibull, "discard.weibull.SANW.csv")
write.csv(discard.schoolfield, "discard.schoolfield.SANW.csv")

discard.weibull <- read_csv("outputs/discard.weibull.SANW.csv")
discard.schoolfield <- read.csv("outputs/discard.schoolfield.SANW.csv")
```


Join the predicted values:
```{r}
tomstFLIR.preds_selected <- tomstFLIR.preds %>%
  select(site, Aspect, datetime, predicted.Tleaf)

preds.dayofcurve <- tomstFLIR.preds_selected %>%
  filter(create_filter_condition(tomstFLIR.preds_selected, date_conditions)) %>%
  filter(format(datetime, "%H:%M:%S") >= "08:00:00" &
           format(datetime, "%H:%M:%S") <= "19:00:00") %>%
  mutate(site = as.character(site)) %>%
  mutate(hourmin_str = format(datetime, "%Y-%m-%d %H:%M:%S"))

preds.avs =preds.dayofcurve%>%
  group_by(site, Aspect)%>%
  summarise(
    pred.ave.Tleaf= mean(predicted.Tleaf),
    pred.range.Tleaf = max(predicted.Tleaf) - min(predicted.Tleaf))

discard.weibull = left_join(discard.weibull, preds.avs, by = c('site', 'Aspect'))
truncated.weibull = left_join(truncated.weibull, preds.avs, by = c('site', 'Aspect'))
discard.schoolfield = left_join(discard.schoolfield, preds.avs, by = c('site', 'Aspect'))
truncated.schoolfield = left_join(truncated.schoolfield, preds.avs, by = c('site', 'Aspect'))

discard.weibull$curveID = as.numeric(discard.weibull$curveID)
vpd.summary$curveID = as.numeric(vpd.summary$curveID)
discard.weibull = left_join(discard.weibull, vpd.summary, by='curveID')
```

________________________________________________________________________________________________________
Plot Topt vs. species for all 9 species:
```{r}
species.plot = ggplot(data = discard.weibull, aes(x = Species, y = T_opt)) +
  geom_boxplot(color = tol_palette9) +
  scale_fill_manual(values = tol_palette9) +
  xlab("Optimal temperature (˚C)")+
  theme_classic()+theme(axis.text.x = element_text(angle = 45, hjust = 1),
    text = element_text(size = 14),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14))
species.plot

summary(lm(T_opt~Species*site,data=discard.weibull))
```


Linear regression of Topt and species. -- No difference between results of truncated vs. discarded
  All the same at the alpha = 0.01 level. Even less significance with the schoolfield than the weibull
```{r}
#Pairwise comparison: 
disc.weib.spec = lm(data=discard.weibull, T_opt~Species)
emmeans_results <- emmeans(disc.weib.spec, pairwise ~ Species)
pairwise_comparisons <- emmeans_results$contrasts
summary(pairwise_comparisons) #None are significant!

(summary(lm(data=discard.schoolfield, T_opt~Species)))
(summary(lm(data=truncated.schoolfield, T_opt~Species)))

```
________________________________________________________________________________________________________
Plot a paired boxplot of Topt vs. elevation 
```{r}
(elev.asp.plot = ggplot(discard.weibull, aes(x = as.factor(Elevation), y = T_opt, fill = Aspect)) +
  geom_boxplot(color = "black", position = position_dodge(width = 0.75)) +
  scale_fill_manual(values = tol_palette2, name = "Aspect", labels = c("East", "West")) +
  theme_classic() +
  xlab("Elevation (m)") + ylab("Topt (˚C)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        text = element_text(size = 17),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14)))
```
Plot a jittered scatterplot of Topt vs. elevation:
```{r}
elev.asp.plot = ggplot(discard.weibull, aes(x = Elevation, y = T_opt)) +
  geom_smooth(method = "lm", se = TRUE, aes(group = 1), color = "black") +
  geom_point(position = position_jitter(width = 50, height = 0), size = 2, color = "black") +
  labs(shape = "Aspect") +
  theme_classic() +
  xlab("Elevation (m)") + 
  ylab("Topt (˚C)") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    text = element_text(size = 17),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  )
  

# Calculate the linear regression model to extract p-value
model.toptelev <- lm(T_opt ~ Elevation, data = discard.weibull)

p_value <- summary(model.toptelev)$coefficients[2,4]

# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)

# Annotate the plot with the p-value
(elev.asp.plot <- elev.asp.plot +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))
```

Linear regression of Topt vs. elevation and aspect
```{r}
disc.site.asp = lm(T_opt~site:Aspect, data = discard.weibull)
emns.site.aspect <- emmeans(disc.site.asp, pairwise ~ site:Aspect)
pairwise_disc.site.asp <- emns.site.aspect$contrasts
summary(pairwise_disc.site.asp) #None are significant!

summary(lm(T_opt~Elevation + Aspect, data = truncated.weibull))
summary(lm(T_opt~Elevation + Aspect, data = discard.schoolfield))
summary(lm(T_opt~Elevation + Aspect, data = truncated.schoolfield))
```
________________________________________________________________________________________________________
Plot of Tomst Topt vs. mean air temperature with shapes and colors being aspect and elevation
```{r}
mean.temp.plot.tom <- discard.weibull %>%
  ggplot(aes(x = tom.ave.air, y = T_opt)) +
  geom_point(aes(color = Elevation, shape = Aspect), size = 2.5) +
  geom_smooth(method = 'lm', se = TRUE, color = "black") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black", linewidth = 0.7) +
   coord_cartesian(xlim = c(5, 28), ylim = c(5, 28)) +
  scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
  scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), labels = c("East", "West")) +
  xlab("Mean air temperature (˚C)") + ylab("Optimal temperature (˚C)") +
  theme_classic() +
  theme(
    text = element_text(size = 17),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  )

# Calculate the linear regression model to extract p-value
model.topttair <- lm(T_opt ~ tom.ave.air*Elevation, data = discard.weibull)

p_value <- summary(model.topttair)$coefficients[2,4]

# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)

# Annotate the plot with the p-value
(mean.temp.plot.tom <- mean.temp.plot.tom +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))
```
Linear regression of Topt vs. tomst mean air temp - None are significant
```{r}
summary(lmer(T_opt~tom.ave.air+ (1|site), data=discard.weibull))

summary(lm(T_opt~tom.ave.air, data=truncated.weibull))

summary(lm(T_opt~tom.ave.air, data=discard.schoolfield))
summary(lm(T_opt~tom.ave.air, data=truncated.schoolfield))
```
________________________________________________________________________________________________________
Plot of FLIR Topt vs. mean air temperature with shapes and colors being aspect and elevation
```{r}
(mean.temp.plot.flr <- discard.weibull %>%
   filter(!is.na(ave.air))%>%
            ggplot(aes(x = ave.air, y = T_opt)) +
            geom_point(aes(color = Elevation, shape = Aspect), size = 2.5) +
            geom_smooth(method = 'lm', se = TRUE, color = "black") +
            geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black", linewidth = 0.7) +
            coord_cartesian(xlim = c(18, 33), ylim = c(18, 33)) +
            scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
            scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), labels = c("East", "West")) +
            xlab("FLIR mean air temperature (˚C)") + ylab("Optimal temperature (˚C)") +
            theme_classic() +
            theme(
              text = element_text(size = 17),
              axis.title.x = element_text(size = 15),
              axis.title.y = element_text(size = 15),
              legend.text = element_text(size = 14),
              legend.title = element_text(size = 14)
      ))
```
Linear regression of Topt vs. FLIR mean air temp - None are significant
```{r}
summary(lm(T_opt~ave.air, data=discard.weibull))
summary(lm(T_opt~ave.air, data=truncated.weibull))

summary(lm(T_opt~ave.air, data=discard.schoolfield))
summary(lm(T_opt~ave.air, data=truncated.schoolfield))
```
________________________________________________________________________________________________________
Plot of FLIR Topt vs. mean leaf temperature with shapes and colors being aspect and elevation
```{r}
mean.Leaftemp.plot.flr <- discard.weibull %>%
  filter(!is.na(ave.leaf), !is.na(T_opt)) %>%  # Ensure both columns are not NA
  ggplot(aes(x = ave.leaf, y = T_opt)) +
  geom_point(aes(color = Elevation, shape = Aspect), size = 2.5) +
  geom_smooth(method = 'lm', se = TRUE, color = "black") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black", linewidth = 0.7) +
  coord_cartesian(xlim = c(15, 35), ylim = c(15, 35)) +
  scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
  scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), labels = c("East", "West")) +
  xlab("Mean leaf temperature (˚C)") + ylab("Optimal temperature (˚C)") +
  theme_classic() +
  theme(
    text = element_text(size = 17),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  )
# Calculate the linear regression model to extract p-value
model.topttleaf <- lm(T_opt ~ ave.leaf*Elevation, data = discard.weibull)

p_value <- summary(model.topttleaf)$coefficients[2,4]

# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)

# Annotate the plot with the p-value
(mean.Leaftemp.plot.flr <- mean.Leaftemp.plot.flr +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))
```
Linear regression of Topt vs. FLIR mean leaf temp - None are significant
```{r}
summary(lm(T_opt~ave.leaf, data=discard.weibull))
summary(lm(T_opt~ave.leaf, data=truncated.weibull))

summary(lm(T_opt~ave.leaf, data=discard.schoolfield))
summary(lm(T_opt~ave.leaf, data=truncated.schoolfield))
```
________________________________________________________________________________________________________
________________________________________________________________________________________________________
FIGURE 2: Topt figure
```{r}
mean.temp.plot.tom <- mean.temp.plot.tom + theme(legend.position = "none",axis.title.y = element_blank())
elev.asp.plot <- elev.asp.plot + theme(axis.title.y = element_blank())
mean.Leaftemp.plot.flr <- mean.Leaftemp.plot.flr + theme(axis.title.y = element_blank())

(Topt.toprow = ggarrange (mean.temp.plot.tom, mean.Leaftemp.plot.flr, nrow=1, ncol=2, common.legend = TRUE, legend = "right", labels=c("A","B")))
figure2 = ggarrange(Topt.toprow, elev.asp.plot, nrow=2, ncol=1,labels=c(" ","C"))
(figure2= annotate_figure(figure2, left = textGrob("Optimal temperature (˚C)", rot = 90, vjust = 1, gp = gpar(cex = 1.3))))
```

________________________________________________________________________________________________________
________________________________________________________________________________________________________
Plot of FLIR Topt vs. predicted leaf temperature with shapes and colors being aspect and elevation
```{r}
(pred.Leaftemp.plot.flr <- discard.weibull %>%
            ggplot(aes(x = ave_VPDleaf, y = T_opt)) +
            geom_point(aes(color = Elevation, shape = Aspect), size = 2.5) +
            geom_smooth(method = 'lm', se = TRUE, color = "black") +
            geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black", linewidth = 0.7) +
            scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
            scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), labels = c("East", "West")) +
            xlab("Predicted mean leaf temperature (˚C)") + ylab("Optimal temperature (˚C)") +
            theme_classic() +
            theme(
              text = element_text(size = 17),
              axis.title.x = element_text(size = 15),
              axis.title.y = element_text(size = 15),
              legend.text = element_text(size = 14),
              legend.title = element_text(size = 14)
      ))
```
________________________________________________________________________________________________________
Plot mjcbreadth vs. mean air temp tomst
```{r}
(b.tom.air <- discard.weibull %>%
            ggplot(aes(x = tom.ave.air, y = mjcbreadth)) +
            geom_point(aes(color = Elevation, shape = Aspect), size = 2.5, 
                       position = position_jitter(width = 0.5, height = 0)) +
            geom_smooth(method = 'lm', se = TRUE, color = "black") +
            scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
            scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), 
                               labels = c("East", "West")) +
            xlab("Average air temperature (˚C)") + ylab("Thermal breadth (˚C)") +
            theme_classic() +
            theme(
              text = element_text(size = 17),
              axis.title.x = element_text(size = 15),
              axis.title.y = element_text(size = 15),
              legend.text = element_text(size = 14),
              legend.title = element_text(size = 14)
      ))

model.b <- lm(mjcbreadth ~ tom.ave.air, data = discard.weibull)
p_value <- summary(model.b)$coefficients[2,4]
# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)
# Annotate the plot with the p-value
(b.tom.air <- b.tom.air +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))




(b.tom.range <- discard.weibull %>%
            ggplot(aes(x = tom.range.air, y = mjcbreadth)) +
            geom_point(aes(color = Elevation, shape = Aspect), size = 2.5,
                       position = position_jitter(width = 0.5, height = 0)) +
            geom_smooth(method = 'lm', se = TRUE, color = "black") +
            scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
            scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), 
                               labels = c("East", "West")) +
            xlab("Temperature Range (˚C)") + ylab("Thermal breadth (˚C)") +
            theme_classic() +
            theme(
              text = element_text(size = 17),
              axis.title.x = element_text(size = 15),
              axis.title.y = element_text(size = 15),
              legend.text = element_text(size = 14),
              legend.title = element_text(size = 14)
      ))
model.br <- lm(mjcbreadth ~ tom.range.air, data = discard.weibull)
p_value <- summary(model.br)$coefficients[2,4]
# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)
# Annotate the plot with the p-value
(b.tom.range <- b.tom.range +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))
b.tom.air=b.tom.air+theme(legend.position = "none")
figure4 = ggarrange(b.tom.air,b.tom.range+rremove("ylab"),nrow=1, common.legend=TRUE,legend = "right",labels = c("A","B"))
```

Plot b vs. mean air temp tomst
```{r}
discard.weibull.filtb = discard.weibull%>%
  filter(b<100)

(b.tom.air.b <- discard.weibull.filtb %>%
            ggplot(aes(x = tom.ave.air, y = b)) +
            geom_point(aes(color = Elevation, shape = Aspect), size = 2.5, 
                       position = position_jitter(width = 0.5, height = 0)) +
            geom_smooth(method = 'lm', se = TRUE, color = "black") +
            scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
            scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), 
                               labels = c("East", "West")) +
            xlab("Average air temperature (˚C)") + ylab("Thermal breadth (˚C)") +
            theme_classic() +
            theme(
              text = element_text(size = 17),
              axis.title.x = element_text(size = 15),
              axis.title.y = element_text(size = 15),
              legend.text = element_text(size = 14),
              legend.title = element_text(size = 14)
      ))

model.bb <- lm(b ~ tom.ave.air, data = discard.weibull.filtb)
p_value <- summary(model.bb)$coefficients[2,4]
# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)
# Annotate the plot with the p-value
(b.tom.air.b <- b.tom.air.b +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))




(b.tom.range.b <- discard.weibull.filtb %>%
            ggplot(aes(x = tom.range.air, y = b)) +
            geom_point(aes(color = Elevation, shape = Aspect), size = 2.5,
                       position = position_jitter(width = 0.5, height = 0)) +
            geom_smooth(method = 'lm', se = TRUE, color = "black") +
            scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
            scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), 
                               labels = c("East", "West")) +
            xlab("Temperature Range (˚C)") + ylab("Thermal breadth (˚C)") +
            theme_classic() +
            theme(
              text = element_text(size = 17),
              axis.title.x = element_text(size = 15),
              axis.title.y = element_text(size = 15),
              legend.text = element_text(size = 14),
              legend.title = element_text(size = 14)
      ))
model.brb <- lm(b ~ tom.range.air, data = discard.weibull.filtb)
p_value <- summary(model.brb)$coefficients[2,4]
# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)
# Annotate the plot with the p-value
(b.tom.range.b <- b.tom.range.b +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))
b.tom.air.b=b.tom.air.b+theme(legend.position = "none")
figure4 = ggarrange(b.tom.air.b,b.tom.range.b+rremove("ylab"),nrow=1, common.legend=TRUE,legend = "right",labels = c("A","B"))
```




```{r}
breadth.elev <- discard.weibull %>%
            ggplot(aes(x = Elevation, y = getbreadth_90)) +
            geom_point(size = 2.5, 
                       position = position_jitter(width = 0.5, height = 0)) +
            geom_smooth(method = 'lm', se = TRUE, color = "black") +
            xlab("Elevation (m)") + ylab("Thermal breadth (˚C)") +
            theme_classic() +
            theme(
              text = element_text(size = 17),
              axis.title.x = element_text(size = 15),
              axis.title.y = element_text(size = 15),
              legend.text = element_text(size = 14),
              legend.title = element_text(size = 14)
      )

model.b.elev <- lm(getbreadth_90 ~ Elevation, data = discard.weibull)
p_value <- summary(model.b.elev)$coefficients[2,4]
# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)
# Annotate the plot with the p-value
(breadth.elev <- breadth.elev +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))
```



Plot getbreadth_90 vs. mean air temp tomst
```{r}
(b.tom.air90 <- discard.weibull %>%
            ggplot(aes(x = tom.ave.air, y = getbreadth_90)) +
            geom_point(aes(color = Elevation, shape = Aspect), size = 2.5, 
                       position = position_jitter(width = 0.5, height = 0)) +
            geom_smooth(method = 'lm', se = TRUE, color = "black") +
            scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
            scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), 
                               labels = c("East", "West")) +
            xlab("Average air temperature (˚C)") + ylab("Thermal breadth (˚C)") +
            theme_classic() +
            theme(
              text = element_text(size = 17),
              axis.title.x = element_text(size = 15),
              axis.title.y = element_text(size = 15),
              legend.text = element_text(size = 14),
              legend.title = element_text(size = 14)
      ))

model.b90 <- lm(getbreadth_90 ~ tom.ave.air, data = discard.weibull)
p_value <- summary(model.b90)$coefficients[2,4]
# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)
# Annotate the plot with the p-value
(b.tom.air90 <- b.tom.air90 +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))




(b.tom.range90 <- discard.weibull %>%
            ggplot(aes(x = tom.range.air, y = getbreadth_90)) +
            geom_point(aes(color = Elevation, shape = Aspect), size = 2.5,
                       position = position_jitter(width = 0.5, height = 0)) +
            geom_smooth(method = 'lm', se = TRUE, color = "black") +
            scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
            scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), 
                               labels = c("East", "West")) +
            xlab("Temperature Range (˚C)") + ylab("Thermal breadth (˚C)") +
            theme_classic() +
            theme(
              text = element_text(size = 17),
              axis.title.x = element_text(size = 15),
              axis.title.y = element_text(size = 15),
              legend.text = element_text(size = 14),
              legend.title = element_text(size = 14)
      ))
model.br90 <- lm(getbreadth_90 ~ tom.range.air, data = discard.weibull)
p_value <- summary(model.br90)$coefficients[2,4]
# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)
# Annotate the plot with the p-value
(b.tom.range90 <- b.tom.range90 +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))
b.tom.air90=b.tom.air90+theme(legend.position = "none")
figure4 = ggarrange(b.tom.air90,b.tom.range90+rremove("ylab"),nrow=1, common.legend=TRUE,legend = "right",labels = c("A","B"))
```
________________________________________________________________________________________________________
Plot of activation energy (E) vs. mean air temperature with shapes and colors being aspect and elevation
```{r}
(mean.temp.plot.E <- discard.schoolfield %>%
  ggplot(aes(x = tom.ave.air, y = E)) +
  geom_point(aes(color = Elevation, shape = Aspect), size = 2.5,
             position = position_jitter(width = 0.5, height = 0)) +
  geom_smooth(method = 'lm', aes(color = Elevation), se = TRUE, color = "black") +
  scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation (m)") +
  scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), labels = c("East", "West")) +
  xlab("Mean air temperature (˚C)") + ylab("Activation energy (eV)") +
  theme_classic() +
  theme(
    text = element_text(size = 17),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  ))
model.Ea <- lm(E ~ tom.ave.air, data = discard.schoolfield)
p_value <- summary(model.Ea)$coefficients[2,4]
# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)
# Annotate the plot with the p-value
(mean.temp.plot.E <- mean.temp.plot.E +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))
```

Plot of deactivation energy (E_D) vs. mean air temperature with shapes and colors being aspect and elevation
```{r}
(mean.temp.plot.ED <- discard.schoolfield %>%
  ggplot(aes(x = tom.ave.air, y = E_D)) +
  geom_point(aes(color = Elevation, shape = Aspect), size = 2.5,
             position = position_jitter(width = 0.5, height = 0)) +
  geom_smooth(method = 'lm', aes(color = Elevation), se = TRUE, color = "black") +
  scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation (m)") +
  scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), labels = c("East", "West")) +
  xlab("Mean air temperature (˚C)") + ylab("De-activation energy (eV)") +
  theme_classic() +
  theme(
    text = element_text(size = 17),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  ))
model.Ed <- lm(E_D ~ tom.ave.air, data = discard.schoolfield)
p_value <- summary(model.Ed)$coefficients[2,4]
# Format the p-value
formatted_p_value <- sprintf("p-value = %.3f", p_value)
# Annotate the plot with the p-value
(mean.temp.plot.ED <- mean.temp.plot.ED +
  annotate("text", x = Inf, y = Inf, label = formatted_p_value, 
           hjust = 1.1, vjust = 25, size = 5))
```
linear regression of activation and deactivation energies
```{r}
summary(lm(E~factor(Elevation)+Aspect, data=discard.schoolfield))
summary(lm(E~tom.ave.air, data=discard.schoolfield))
summary(lm(E_D~factor(Elevation)+Aspect, data=discard.schoolfield))
summary(lm(E_D~tom.ave.air, data=discard.schoolfield))



mean(discard.schoolfield$E)
mean(truncated.schoolfield$E)

mean(discard.schoolfield$E_D)
mean(truncated.schoolfield$E_D)
```

FIGURE 5
```{r}
mean.temp.plot.E = mean.temp.plot.E +theme(legend.position = "none")
figure5 = ggarrange(mean.temp.plot.E, mean.temp.plot.ED, nrow=1, common.legend=TRUE,legend = "right", labels=c("A","B"))

```

________________________________________________________________________________________________________

Flir Tleaf pixel distributions
```{r}
set.seed(1)

#Site 1E - stick together the two halves and then get rid of a bunch of data to make it small enough to plot
pixels.1EA = read_csv("data/1EA_51624_pix_pixel_temps.csv")
pix.1EA <- pivot_longer(pixels.1EA, cols = -Pixel, names_to = "time", values_to = "temperature")
pixels.1EB = read_csv("data/1EB_51624_pix_pixel_temps.csv")
pix.1EB <- pivot_longer(pixels.1EB, cols = -Pixel, names_to = "time", values_to = "temperature")
pix.1E <- rbind(pix.1EA, pix.1EB)

num_rows_to_keep.1E <- floor(nrow(pix.1E) / 1000)
#print(paste("Number of rows to keep:", num_rows_to_keep.1E))
# Randomly sample row indices to keep
rows_to_keep.1E <- sample(seq_len(nrow(pix.1E)), size = num_rows_to_keep.1E)
pix.1E.small <- pix.1E[rows_to_keep.1E, ]
plotpix.1E <- ggplot(pix.1E.small, aes(x=temperature-273.15)) +
  geom_histogram(binwidth=1, fill="black", color="black")+
  xlab("Leaf temperature") + theme_classic()

pixels.1W = read_csv("data/1W_51624_pix_pixel_temps.csv")
pix.1W <- pivot_longer(pixels.1W, cols = -Pixel, names_to = "time", values_to = "temperature")
num_rows_to_keep.1W <- floor(nrow(pix.1W) / 1000)
# Randomly sample row indices to keep
rows_to_keep.1W <- sample(seq_len(nrow(pix.1W)), size = num_rows_to_keep.1W)
pix.1W.small <- pix.1W[rows_to_keep.1W, ]
plotpix.1W <- ggplot(pix.1W.small, aes(x=temperature-273.15)) +
  geom_histogram(binwidth=1, fill="black", color="black")+
  xlab("Leaf temperature") + theme_classic()

pixels.5W = read_csv("data/5W_51624_pix_pixel_temps.csv")
pix.5W <- pivot_longer(pixels.5W, cols = -Pixel, names_to = "time", values_to = "temperature")
num_rows_to_keep.5W <- floor(nrow(pix.5W) / 1000)
# Randomly sample row indices to keep
rows_to_keep.5W <- sample(seq_len(nrow(pix.5W)), size = num_rows_to_keep.5W)
pix.5W.small <- pix.5W[rows_to_keep.5W, ]
plotpix.5W <- ggplot(pix.5W.small, aes(x=temperature-273.15)) +
  geom_histogram(binwidth=1, fill="black", color="black")+
  xlab("Leaf temperature") + theme_classic()


pixels.5E = read_csv("data/5E_51624_pix_pixel_temps.csv")
pix.5E <- pivot_longer(pixels.5E, cols = -Pixel, names_to = "time", values_to = "temperature")
num_rows_to_keep.5E <- floor(nrow(pix.5E) / 1000)
# Randomly sample row indices to keep
rows_to_keep.5E <- sample(seq_len(nrow(pix.5E)), size = num_rows_to_keep.5E)
pix.5E.small <- pix.5E[rows_to_keep.5E, ]
plotpix.5E <- ggplot(pix.5E.small, aes(x=temperature-273.15)) +
  geom_histogram(binwidth=1, fill="black", color="black")+
  xlab("Leaf temperature") + theme_classic()

```

```{r}
(vpdplot <- discard.weibull %>%
            ggplot(aes(x = avg_VPDleaf, y = T_opt)) +
            geom_point(aes(color = Elevation, shape = Aspect), size = 2.5) +
            geom_smooth(method = 'lm', se = TRUE, color = "black") +
            geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black", linewidth = 0.7) +
            scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
            scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), labels = c("East", "West")) +
            xlab("VPDleaf") + ylab("Optimal temperature (˚C)") +
            theme_classic() +
            theme(
              text = element_text(size = 17),
              axis.title.x = element_text(size = 15),
              axis.title.y = element_text(size = 15),
              legend.text = element_text(size = 14),
              legend.title = element_text(size = 14)
      ))
```

```{r}
mean.Leaftemp.vpd <- discard.weibull %>%
  ggplot(aes(x = Elevation, y = avg_VPDleaf)) +
  geom_point(aes(color = Elevation, shape = Aspect), size = 2.5) +
  geom_smooth(method = 'lm', se = TRUE, color = "black") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black", linewidth = 0.7) +
  scale_color_gradient(low = "#332288", high = "#009988", name = "Elevation") +
  scale_shape_manual(name = "Aspect", values = c("E" = 16, "W" = 17), labels = c("East", "West")) +
  xlab("Elevation (m)") + ylab("VPDleaf") +
  theme_classic() +
  theme(
    text = element_text(size = 17),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  )

mean.Leaftemp.vpd

summary(lm(avg_VPDleaf~Elevation, data=discard.weibull))
```
